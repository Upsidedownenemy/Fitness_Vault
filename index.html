<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalisTrack Pro • Production Build</title>
    <!-- Tailwind CSS (Stable Production CDN) -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <!-- Firebase Legacy Compatibility Scripts (Best for Static Hosting) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        input, select { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; outline-color: #3b82f6; background: #fff; }
        th { text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.1em; color: #64748b; background: #f8fafc; }
        .loader { border-top-color: #3b82f6; animation: spinner 0.6s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div class="max-w-7xl mx-auto px-4 py-8">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-3xl font-black text-slate-800 flex items-center gap-2">
                    <span class="bg-blue-600 text-white p-1.5 rounded-lg text-xl">CP</span>
                    CalisTrack <span class="text-blue-600">Pro</span>
                </h1>
                <p class="text-slate-500 font-medium text-xs mt-1" id="userIdentifier">Verifying Vault Connection...</p>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="statusIndicator" class="px-3 py-2 bg-slate-100 rounded-xl text-[10px] font-black flex items-center gap-2">
                    <div id="statusDot" class="w-2 h-2 bg-orange-400 rounded-full animate-pulse"></div>
                    <span id="statusText">CONNECTING</span>
                </div>
                <button onclick="toggleSettings(true)" class="p-3 bg-slate-100 hover:bg-slate-200 rounded-xl transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
            </div>
        </header>

        <!-- Stats Overview Bar -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
            <div class="bg-blue-600 p-4 rounded-2xl shadow-sm text-white flex flex-col justify-center">
                <span class="text-[10px] font-black uppercase tracking-widest opacity-80">Baseline BMR</span>
                <div class="flex items-baseline gap-1">
                    <span id="bmrValue" class="text-2xl font-black">---</span>
                    <span class="text-xs font-bold opacity-80">kcal/day</span>
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-center">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Profile Basis</span>
                <div class="flex items-center gap-3 mt-1">
                    <span id="statWeight" class="text-sm font-black text-slate-700">--kg</span>
                    <div class="w-1 h-1 bg-slate-300 rounded-full"></div>
                    <span id="statHeight" class="text-sm font-black text-slate-700">--cm</span>
                    <div class="w-1 h-1 bg-slate-300 rounded-full"></div>
                    <span id="statAge" class="text-sm font-black text-slate-700">--yrs</span>
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-center">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Active Multipliers</span>
                <div class="flex gap-2 mt-1 overflow-x-auto no-scrollbar">
                    <span class="text-[9px] font-bold bg-slate-100 px-2 py-0.5 rounded text-slate-600 whitespace-nowrap">Push: <span id="valPush">-</span></span>
                    <span class="text-[9px] font-bold bg-slate-100 px-2 py-0.5 rounded text-slate-600 whitespace-nowrap">Pull: <span id="valPull">-</span></span>
                </div>
            </div>
        </div>

        <!-- Main Form -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <input type="date" id="newDate" class="w-full text-sm">
                <select id="newType" class="text-sm">
                    <option value="Push">Push</option>
                    <option value="Pull">Pull</option>
                    <option value="Legs">Legs</option>
                    <option value="Rest">Rest</option>
                </select>
                <input type="number" id="newReps" placeholder="Reps" class="text-sm">
                <input type="number" id="newSteps" placeholder="Steps" class="text-sm">
                <input type="number" id="newFood" placeholder="Kcal" class="text-sm">
            </div>
            <button id="addBtn" onclick="addNewRow()" class="mt-4 w-full bg-blue-600 text-white font-black py-4 rounded-xl uppercase text-xs tracking-widest hover:bg-blue-700 transition-all">Add to Ledger</button>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative min-h-[300px]">
            <div id="tableLoader" class="absolute inset-0 bg-white/90 flex flex-col items-center justify-center z-10">
                <div class="loader rounded-full border-4 h-10 w-10 mb-2 border-slate-200"></div>
                <p class="text-[10px] font-black text-slate-400">CONNECTING TO DATABASE...</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="p-4 text-left border-b">Date</th>
                            <th class="p-4 text-left border-b">Type</th>
                            <th class="p-4 text-center border-b">Steps</th>
                            <th class="p-4 text-center border-b bg-blue-50/50">Total Out</th>
                            <th class="p-4 text-center border-b bg-amber-50/50">Food In</th>
                            <th class="p-4 text-center border-b">Net</th>
                            <th class="p-4 border-b"></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authOverlay" class="fixed inset-0 modal-overlay z-[100] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center">
            <h2 class="text-2xl font-black mb-2">Cloud Vault Login</h2>
            <p class="text-slate-400 text-sm mb-6">Access your data from any device.</p>
            <div class="space-y-4 text-left">
                <input type="text" id="loginUser" class="w-full" placeholder="Username">
                <input type="password" id="loginPass" class="w-full" placeholder="Password">
                <button onclick="handleAuthSubmit()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl">Enter Vault</button>
                <button onclick="handleQuickStart()" class="w-full text-slate-400 font-bold text-xs uppercase pt-2">Use without Cloud Sync</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 modal-overlay z-[110] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full flex flex-col max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h2 class="text-sm font-black text-slate-800 uppercase tracking-widest">System Configuration</h2>
                <button onclick="toggleSettings(false)" class="p-2 hover:bg-slate-200 rounded-lg">✕</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-8 space-y-8">
                <!-- Biometrics -->
                <section>
                    <h3 class="text-[10px] font-black text-blue-600 uppercase mb-4 tracking-widest">Biometric Data</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="flex flex-col"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1">Weight kg</label><input type="number" id="userWeight"></div>
                        <div class="flex flex-col"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1">Height cm</label><input type="number" id="userHeight"></div>
                        <div class="flex flex-col"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1">Age</label><input type="number" id="userAge"></div>
                    </div>
                </section>

                <!-- Advanced Formula Settings -->
                <section class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                    <h3 class="text-[10px] font-black text-blue-600 uppercase mb-4 tracking-widest flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m2 16 20 6-6-20L2 16Z"/><path d="m9 9 5 5"/></svg>
                        Formula Lab (Advance)
                    </h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
                        <div class="flex flex-col"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1">Push kcal/rep</label><input type="number" step="0.01" id="mPush"></div>
                        <div class="flex flex-col"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1">Pull kcal/rep</label><input type="number" step="0.01" id="mPull"></div>
                        <div class="flex flex-col"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1">Legs kcal/rep</label><input type="number" step="0.01" id="mLegs"></div>
                        <div class="flex flex-col"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1">Step Factor</label><input type="number" step="0.001" id="mSteps"></div>
                    </div>
                    <p class="text-[9px] text-slate-400 italic">Formula: (Reps × Factor) + (Steps × Weight × Step Factor / 1000)</p>
                </section>

                <!-- Cloud Sync -->
                <section>
                    <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Vault Sync</h3>
                    <div class="flex gap-2">
                        <input type="text" id="linkUser" placeholder="Global Username" class="flex-1 text-sm">
                        <input type="password" id="linkPass" placeholder="Secret Key" class="flex-1 text-sm">
                    </div>
                    <button onclick="linkAccount()" class="w-full mt-3 bg-slate-900 text-white py-3 rounded-xl text-[10px] font-black uppercase tracking-widest">Bind Device to Vault</button>
                </section>
            </div>

            <div class="p-6 border-t bg-slate-50 flex gap-4">
                <button onclick="saveSettings()" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-xs">Commit Changes</button>
                <button onclick="toggleSettings(false)" class="px-6 font-bold text-slate-400 text-xs">CANCEL</button>
            </div>
        </div>
    </div>

    <script>
        // Use the explicit configuration provided, or fall back to environment variable
        const fbConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDBqYibQfxlZmi-mF2CP8G3aa_pETdK9qQ",
            authDomain: "f-tness-tracker.firebaseapp.com",
            projectId: "f-tness-tracker",
            storageBucket: "f-tness-tracker.firebasestorage.app",
            messagingSenderId: "746828310290",
            appId: "1:746828310290:web:66d9b477e78e6ad2deb5cb"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fitness-vault-production';
        
        firebase.initializeApp(fbConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let settings = {
            profile: { weight: 110, height: 185, age: 25 },
            multipliers: { Push: 1.5, Pull: 1.5, Legs: 1.47, Steps: 0.045 }
        };

        const setStatus = (text, color) => {
            const dot = document.getElementById('statusDot');
            if(dot) dot.className = `w-2 h-2 rounded-full bg-${color}-500 ${color === 'emerald' ? 'animate-pulse' : ''}`;
            document.getElementById('statusText').innerText = text;
        };

        async function startApp() {
            setStatus("AUTH", "orange");
            document.getElementById('newDate').valueAsDate = new Date();

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    document.getElementById('userIdentifier').innerText = `VAULT ACTIVE: ${user.uid.substring(0,8)}`;
                    setStatus("CONNECTED", "emerald");
                    document.getElementById('authOverlay').classList.add('hidden');
                    
                    const snap = await db.doc(`artifacts/${appId}/users/${user.uid}/settings/config`).get();
                    if(snap.exists) settings = snap.data();
                    updateHomeStats();
                    loadLogs(user.uid);
                } else {
                    const savedU = localStorage.getItem('vault_u');
                    if (!savedU) {
                        // Priority 1: Auth token from environment
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token).catch(() => auth.signInAnonymously());
                        } else {
                            await auth.signInAnonymously().catch(() => setStatus("ERROR", "red"));
                        }
                    } else {
                        document.getElementById('authOverlay').classList.remove('hidden');
                    }
                }
            });
        }

        function updateHomeStats() {
            const bmr = Math.round((10 * settings.profile.weight) + (6.25 * settings.profile.height) - (5 * settings.profile.age) + 5);
            document.getElementById('bmrValue').innerText = bmr;
            document.getElementById('statWeight').innerText = settings.profile.weight + 'kg';
            document.getElementById('statHeight').innerText = settings.profile.height + 'cm';
            document.getElementById('statAge').innerText = settings.profile.age + 'yrs';
            document.getElementById('valPush').innerText = settings.multipliers.Push;
            document.getElementById('valPull').innerText = settings.multipliers.Pull;
        }

        function loadLogs(uid) {
            db.collection(`artifacts/${appId}/users/${uid}/logs`)
              .onSnapshot(snap => {
                  const logs = [];
                  snap.forEach(d => logs.push({id: d.id, ...d.data()}));
                  logs.sort((a,b) => b.timestamp - a.timestamp);
                  render(logs);
                  document.getElementById('tableLoader').classList.add('hidden');
              }, err => setStatus("OFFLINE", "red"));
        }

        function render(logs) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            const bmr = Math.round((10 * settings.profile.weight) + (6.25 * settings.profile.height) - (5 * settings.profile.age) + 5);

            logs.forEach(log => {
                const repMultiplier = settings.multipliers[log.type] || 0;
                const actBurn = Math.round((log.reps * repMultiplier) + (log.steps * settings.profile.weight * settings.multipliers.Steps / 1000));
                const out = bmr + actBurn;
                const net = log.food - out;

                tbody.innerHTML += `
                    <tr class="text-xs">
                        <td class="p-4 font-bold text-slate-600">${log.dateLabel}</td>
                        <td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded font-black">${log.type}</span></td>
                        <td class="p-4 text-center">${log.steps.toLocaleString()}</td>
                        <td class="p-4 text-center font-bold text-blue-600">${out}</td>
                        <td class="p-4 text-center font-bold text-amber-600">${log.food}</td>
                        <td class="p-4 text-center">
                            <span class="px-2 py-1 rounded-lg font-black ${net < 0 ? 'bg-emerald-50 text-emerald-600':'bg-red-50 text-red-600'}">
                                ${net}
                            </span>
                        </td>
                        <td class="p-4 text-right">
                            <button onclick="deleteLog('${log.id}')" class="text-slate-300 hover:text-red-500">✕</button>
                        </td>
                    </tr>
                `;
            });
        }

        window.addNewRow = async () => {
            if(!auth.currentUser) return;
            const d = new Date(document.getElementById('newDate').value + 'T12:00:00');
            await db.collection(`artifacts/${appId}/users/${auth.currentUser.uid}/logs`).add({
                timestamp: d.getTime(),
                dateLabel: d.toLocaleDateString(),
                type: document.getElementById('newType').value,
                reps: parseInt(document.getElementById('newReps').value) || 0,
                steps: parseInt(document.getElementById('newSteps').value) || 0,
                food: parseInt(document.getElementById('newFood').value) || 0
            });
        };

        window.deleteLog = async (id) => {
            if(confirm("Erase entry?")) await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/logs/${id}`).delete();
        };

        window.handleAuthSubmit = async () => {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            const snap = await db.doc(`artifacts/${appId}/public/data/vault_mappings/${u}`).get();
            if(snap.exists() && snap.data().pass === p) {
                localStorage.setItem('vault_u', u);
                location.reload();
            } else {
                alert("Credentials invalid.");
            }
        };

        window.linkAccount = async () => {
            const u = document.getElementById('linkUser').value;
            const p = document.getElementById('linkPass').value;
            if(!u || !p) return;
            await db.doc(`artifacts/${appId}/public/data/vault_mappings/${u}`).set({ uid: auth.currentUser.uid, pass: p });
            localStorage.setItem('vault_u', u);
            alert("Vault linked!");
        };

        window.saveSettings = async () => {
            settings.profile = {
                weight: parseFloat(document.getElementById('userWeight').value) || 70,
                height: parseFloat(document.getElementById('userHeight').value) || 170,
                age: parseFloat(document.getElementById('userAge').value) || 25
            };
            settings.multipliers = {
                Push: parseFloat(document.getElementById('mPush').value) || 1.5,
                Pull: parseFloat(document.getElementById('mPull').value) || 1.5,
                Legs: parseFloat(document.getElementById('mLegs').value) || 1.47,
                Steps: parseFloat(document.getElementById('mSteps').value) || 0.045
            };
            await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/settings/config`).set(settings);
            updateHomeStats();
            toggleSettings(false);
        };

        window.toggleSettings = (s) => {
            document.getElementById('settingsModal').classList.toggle('hidden', !s);
            if(s) {
                document.getElementById('userWeight').value = settings.profile.weight;
                document.getElementById('userHeight').value = settings.profile.height;
                document.getElementById('userAge').value = settings.profile.age;
                document.getElementById('mPush').value = settings.multipliers.Push;
                document.getElementById('mPull').value = settings.multipliers.Pull;
                document.getElementById('mLegs').value = settings.multipliers.Legs;
                document.getElementById('mSteps').value = settings.multipliers.Steps;
            }
        };

        window.handleQuickStart = () => document.getElementById('authOverlay').classList.add('hidden');
        window.onload = startApp;
    </script>
</body>
</html>
