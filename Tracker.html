<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalisTrack Pro • Global Vault</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Legacy Compatibility Scripts (Best for file:// and GitHub Pages) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        input, select { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; outline-color: #3b82f6; background: #fff; }
        .delta-pos { color: #ef4444; font-weight: bold; }
        .delta-neg { color: #10b981; font-weight: bold; }
        th { text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.1em; color: #64748b; background: #f8fafc; }
        .loader { border-top-color: #3b82f6; animation: spinner 0.6s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); }
        .github-card { background: linear-gradient(135deg, #24292e 0%, #1a1e22 100%); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div class="max-w-7xl mx-auto px-4 py-8">
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-3xl font-black text-slate-800 flex items-center gap-2">
                    <span class="bg-blue-600 text-white p-1.5 rounded-lg text-xl">CP</span>
                    CalisTrack <span class="text-blue-600">Pro</span>
                </h1>
                <p class="text-slate-500 font-medium text-xs mt-1" id="userIdentifier">Initializing System...</p>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <span class="text-[10px] font-black text-slate-400 block uppercase tracking-widest">Global BMR</span>
                    <span id="bmrDisplay" class="text-2xl font-black text-slate-800">0</span>
                </div>
                <button onclick="toggleSettings(true)" class="p-3 bg-slate-100 hover:bg-slate-200 rounded-xl transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
                <div id="statusIndicator" class="px-3 py-2 bg-slate-100 rounded-xl text-[10px] font-black flex items-center gap-2">
                    <div id="statusDot" class="w-2 h-2 bg-orange-400 rounded-full animate-pulse"></div>
                    <span id="statusText">BOOTING</span>
                </div>
            </div>
        </header>

        <!-- Main Form -->
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Daily Performance Log</h3>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <input type="date" id="newDate" class="w-full text-sm border-slate-200">
                <select id="newType" class="text-sm border-slate-200">
                    <option value="Push">Push</option>
                    <option value="Pull">Pull</option>
                    <option value="Legs">Legs</option>
                    <option value="Rest">Rest</option>
                </select>
                <input type="number" id="newReps" placeholder="Strength Reps" class="text-sm border-slate-200">
                <input type="number" id="newSteps" placeholder="Step Count" class="text-sm border-slate-200">
                <input type="number" id="newFood" placeholder="Food Kcal" class="text-sm border-slate-200">
            </div>
            <button id="addBtn" onclick="addNewRow()" class="mt-4 w-full bg-blue-600 text-white font-black py-4 rounded-xl uppercase text-xs tracking-widest hover:bg-blue-700 transition-all shadow-lg active:scale-95 disabled:opacity-50">Sync Daily Entry</button>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative min-h-[300px]">
            <div id="tableLoader" class="absolute inset-0 bg-white/90 flex flex-col items-center justify-center z-10">
                <div class="loader rounded-full border-4 h-10 w-10 mb-2 border-slate-200"></div>
                <p class="text-[10px] font-black text-slate-400">ACCESSING ENCRYPTED VAULT...</p>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="p-4 text-left border-b">Date</th>
                            <th class="p-4 text-left border-b">Focus</th>
                            <th class="p-4 text-center border-b">Steps</th>
                            <th class="p-4 text-center border-b">Activity</th>
                            <th class="p-4 text-center border-b bg-blue-50/50">Total Out</th>
                            <th class="p-4 text-center border-b bg-amber-50/50">Food In</th>
                            <th class="p-4 text-center border-b">Net Balance</th>
                            <th class="p-4 border-b"></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="authOverlay" class="fixed inset-0 modal-overlay z-[100] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full">
            <div class="w-12 h-12 bg-blue-600 text-white rounded-xl flex items-center justify-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>
            </div>
            <h2 class="text-2xl font-black mb-1">Cloud Vault</h2>
            <p class="text-slate-400 text-sm mb-6">Enter credentials to decrypt your history.</p>
            <div class="space-y-4">
                <input type="text" id="loginUser" class="w-full border-slate-200" placeholder="Username">
                <input type="password" id="loginPass" class="w-full border-slate-200" placeholder="Password">
                <button onclick="handleAuthSubmit()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl shadow-lg hover:bg-blue-700 transition-all">Access Data</button>
                <div class="flex items-center gap-4 py-2">
                    <div class="h-px bg-slate-100 flex-1"></div>
                    <span class="text-[10px] font-bold text-slate-300">OR</span>
                    <div class="h-px bg-slate-100 flex-1"></div>
                </div>
                <button onclick="handleQuickStart()" class="w-full text-slate-400 font-bold text-xs uppercase hover:text-slate-600">Temporary Session</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 modal-overlay z-[110] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full flex flex-col max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h2 class="text-sm font-black text-slate-800 uppercase tracking-widest">Global Configuration</h2>
                <button onclick="toggleSettings(false)" class="p-2 hover:bg-slate-200 rounded-lg">✕</button>
            </div>
            <div class="flex-1 overflow-y-auto p-8 space-y-8">
                <!-- Body Profile -->
                <section>
                    <h3 class="text-[10px] font-black text-blue-600 uppercase mb-4 tracking-widest">Biometric Data</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="flex flex-col"><label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Weight kg</label><input type="number" id="userWeight"></div>
                        <div class="flex flex-col"><label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Height cm</label><input type="number" id="userHeight"></div>
                        <div class="flex flex-col"><label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Age</label><input type="number" id="userAge"></div>
                    </div>
                </section>

                <!-- GitHub Guide -->
                <section class="github-card p-6 rounded-2xl text-white">
                    <div class="flex items-center gap-3 mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
                        <h3 class="font-black text-sm uppercase tracking-widest">Deploy to GitHub Pages</h3>
                    </div>
                    <ul class="text-[11px] space-y-2 opacity-80 list-disc ml-4">
                        <li>Create a New Repository (e.g. "fitness-vault").</li>
                        <li>Upload this <code>tracker.html</code> file.</li>
                        <li>Go to <b>Settings > Pages</b> and set branch to <code>main</code>.</li>
                        <li>Your app will be live at <code>https://username.github.io/fitness-vault</code></li>
                    </ul>
                </section>

                <!-- Syncing -->
                <section id="linkSection" class="border-t pt-8">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Account Linking</h3>
                    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                        <div class="flex gap-4 mb-4">
                            <input type="text" id="linkUser" placeholder="Global Username" class="flex-1 text-sm">
                            <input type="password" id="linkPass" placeholder="Secret Key" class="flex-1 text-sm">
                        </div>
                        <button onclick="linkAccount()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold text-xs uppercase tracking-widest">Bind Device to Global User</button>
                    </div>
                </section>
            </div>
            <div class="p-6 border-t bg-slate-50 flex gap-4">
                <button onclick="saveSettings()" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-xs">Save Changes</button>
                <button onclick="toggleSettings(false)" class="px-6 font-bold text-slate-400 text-xs">CLOSE</button>
            </div>
        </div>
    </div>

    <script>
        // CRITICAL: Robust Config Loading
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(__firebase_config);
        } catch(e) {
            console.warn("Using fallback config structure.");
            firebaseConfig = {
                apiKey: "", // Handled by environment
                authDomain: window.location.hostname,
                projectId: "calistrack-global",
                storageBucket: "calistrack-global.appspot.com",
                messagingSenderId: "12345",
                appId: "1:12345:web:12345"
            };
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'calistrack-v3-global';
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let settings = {
            profile: { weight: 110, height: 185, age: 25 },
            multipliers: { Push: 1.5, Pull: 1.5, Legs: 1.47, Steps: 0.045 }
        };

        const setStatus = (text, color) => {
            const dot = document.getElementById('statusDot');
            if(dot) dot.className = `w-2 h-2 rounded-full bg-${color}-500 ${color === 'emerald' ? 'animate-pulse' : ''}`;
            document.getElementById('statusText').innerText = text;
        };

        const updateBMRDisplay = () => {
            const b = Math.round((10 * settings.profile.weight) + (6.25 * settings.profile.height) - (5 * settings.profile.age) + 5);
            document.getElementById('bmrDisplay').innerText = b;
            return b;
        };

        async function startApp() {
            setStatus("VERIFYING", "orange");
            document.getElementById('newDate').valueAsDate = new Date();

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    document.getElementById('userIdentifier').innerText = `VAULT_ID: ${user.uid.substring(0,10)}`;
                    setStatus("SYNCED", "emerald");
                    document.getElementById('authOverlay').classList.add('hidden');
                    
                    // Load User Specific Config
                    const snap = await db.doc(`artifacts/${appId}/users/${user.uid}/settings/config`).get();
                    if(snap.exists) settings = snap.data();
                    
                    updateBMRDisplay();
                    loadLogs(user.uid);
                } else {
                    const savedU = localStorage.getItem('v_user');
                    const savedP = localStorage.getItem('v_pass');
                    if (!savedU) {
                        await auth.signInAnonymously().catch(err => setStatus("OFFLINE", "red"));
                    } else {
                        document.getElementById('authOverlay').classList.remove('hidden');
                    }
                }
            });
        }

        window.handleAuthSubmit = async () => {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            if(!u || !p) return;
            
            setStatus("DECRYPTING", "blue");
            const snap = await db.doc(`artifacts/${appId}/public/data/vault_mappings/${u}`).get();
            if(snap.exists() && snap.data().pass === p) {
                localStorage.setItem('v_user', u);
                localStorage.setItem('v_pass', p);
                location.reload();
            } else {
                setStatus("DENIED", "red");
                alert("Vault access key incorrect.");
            }
        };

        window.handleQuickStart = () => document.getElementById('authOverlay').classList.add('hidden');

        function loadLogs(uid) {
            db.collection(`artifacts/${appId}/users/${uid}/logs`)
              .onSnapshot(snap => {
                  const logs = [];
                  snap.forEach(d => logs.push({id: d.id, ...d.data()}));
                  logs.sort((a,b) => b.timestamp - a.timestamp);
                  render(logs);
                  document.getElementById('tableLoader').classList.add('hidden');
              }, err => setStatus("QUERY_ERR", "red"));
        }

        function render(logs) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            const bmr = updateBMRDisplay();

            if(logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="p-12 text-center text-slate-300 font-bold uppercase text-[10px]">Vault Empty</td></tr>';
                return;
            }

            logs.forEach(log => {
                const sBurn = log.reps * (settings.multipliers[log.type] || 0);
                const stepBurn = (log.steps * settings.profile.weight * settings.multipliers.Steps) / 1000;
                const actBurn = Math.round(sBurn + stepBurn);
                const out = bmr + actBurn;
                const net = log.food - out;

                tbody.innerHTML += `
                    <tr class="text-xs hover:bg-slate-50 transition-colors">
                        <td class="p-4 font-bold text-slate-600">${log.dateLabel}</td>
                        <td class="p-4"><span class="bg-slate-900 text-white px-2 py-0.5 rounded text-[9px] font-black uppercase">${log.type}</span></td>
                        <td class="p-4 text-center font-mono text-slate-400">${log.steps.toLocaleString()}</td>
                        <td class="p-4 text-center font-bold text-slate-500">${actBurn}</td>
                        <td class="p-4 text-center bg-blue-50/30 font-black text-blue-600">${out}</td>
                        <td class="p-4 text-center bg-amber-50/30 font-black text-amber-600">${log.food}</td>
                        <td class="p-4 text-center">
                            <span class="px-2 py-1 rounded-lg font-black ${net < 0 ? 'bg-emerald-50 text-emerald-600':'bg-red-50 text-red-600'}">
                                ${net > 0 ? '+' : ''}${net}
                            </span>
                        </td>
                        <td class="p-4 text-right">
                            <button onclick="deleteLog('${log.id}')" class="text-slate-200 hover:text-red-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        window.addNewRow = async () => {
            const btn = document.getElementById('addBtn');
            btn.disabled = true;
            const uid = auth.currentUser.uid;
            const dateStr = document.getElementById('newDate').value;
            const d = dateStr ? new Date(dateStr + 'T12:00:00') : new Date();
            
            try {
                await db.collection(`artifacts/${appId}/users/${uid}/logs`).add({
                    timestamp: d.getTime(),
                    dateLabel: d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                    type: document.getElementById('newType').value,
                    reps: parseInt(document.getElementById('newReps').value) || 0,
                    steps: parseInt(document.getElementById('newSteps').value) || 0,
                    food: parseInt(document.getElementById('newFood').value) || 0
                });
                document.getElementById('newReps').value = '';
                document.getElementById('newSteps').value = '';
                document.getElementById('newFood').value = '';
            } finally {
                btn.disabled = false;
            }
        };

        window.deleteLog = async (id) => {
            if(confirm("Permanently erase record?")) {
                await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/logs/${id}`).delete();
            }
        };

        window.saveSettings = async () => {
            settings.profile = {
                weight: parseFloat(document.getElementById('userWeight').value) || 110,
                height: parseFloat(document.getElementById('userHeight').value) || 185,
                age: parseFloat(document.getElementById('userAge').value) || 25
            };
            await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/settings/config`).set(settings);
            updateBMRDisplay();
            toggleSettings(false);
        };

        window.linkAccount = async () => {
            const u = document.getElementById('linkUser').value.trim();
            const p = document.getElementById('linkPass').value.trim();
            if(!u || !p || !auth.currentUser) return;
            
            await db.doc(`artifacts/${appId}/public/data/vault_mappings/${u}`).set({
                uid: auth.currentUser.uid,
                pass: p
            });
            localStorage.setItem('v_user', u);
            localStorage.setItem('v_pass', p);
            alert("Device linked to vault: " + u);
        };

        window.toggleSettings = (s) => {
            document.getElementById('settingsModal').classList.toggle('hidden', !s);
            document.getElementById('userWeight').value = settings.profile.weight;
            document.getElementById('userHeight').value = settings.profile.height;
            document.getElementById('userAge').value = settings.profile.age;
        };

        window.onload = startApp;
    </script>
</body>
</html>
